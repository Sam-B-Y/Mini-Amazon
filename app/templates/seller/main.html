{% extends "base.html" %} {% block content %}

<div
  class="modal fade"
  id="addItemModal"
  tabindex="-1"
  role="dialog"
  aria-labelledby="addItemModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="addItemModalLabel">Add New Listing</h5>
        <button
          type="button"
          class="close"
          data-dismiss="modal"
          aria-label="Close"
        >
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <button
            class="btn btn-primary w-100 mb-3"
            id="createNewProductBtn"
          >
            Create New Product
          </button>
          <button
            class="btn btn-secondary w-100"
            id="selectExistingProductBtn"
          >
            Select Existing Product
          </button>
        </div>

        <!-- New Product Form -->
        <form id="newProductForm" class="d-none">
          <h5 class="mb-3">New Product Details</h5>
          <div class="form-group">
            <label for="category_name">Category Name:</label>
            <input
              type="text"
              id="category_name"
              name="category_name"
              class="form-control"
              required
            />
          </div>
          <div class="form-group">
            <label for="name">Product Name:</label>
            <input
              type="text"
              id="name"
              name="name"
              class="form-control"
              required
            />
          </div>
          <div class="form-group">
            <label for="description">Description:</label>
            <textarea
              id="description"
              name="description"
              class="form-control"
              rows="3"
              required
            ></textarea>
          </div>
          <div class="form-group">
            <label for="image_url">Image URL:</label>
            <input
              type="url"
              id="image_url"
              name="image_url"
              class="form-control"
              required
            />
          </div>
          <div class="form-group">
            <label for="price">Price:</label>
            <input
              type="number"
              id="price"
              name="price"
              class="form-control"
              step="0.01"
              required
            />
          </div>
          <div class="form-group">
            <label for="quantity">Quantity:</label>
            <input
              type="number"
              id="quantity"
              name="quantity"
              class="form-control"
              required
            />
          </div>
          <button type="submit" class="btn btn-primary w-100">
            Submit New Product
          </button>
        </form>

        <!-- Existing Product Search -->
        <div id="existingProductForm" class="d-none">
          <h5 class="mb-3">Select Existing Product</h5>
          <div class="form-group">
            <label for="search_existing">Search Product:</label>
            <input
              type="text"
              id="search_existing"
              class="form-control"
              placeholder="Search by product name or category"
            />
          </div>
          <button class="btn btn-primary w-100 mb-3" id="searchProductBtn">
            Search
          </button>
          <div id="productResults" class="mt-3"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="container" style="text-align: center; margin-top: 50px">
  <h2>Seller Information</h2>
  <div class="row" style="margin-top: 50px">
    {% if seller_stats is not none%}
      <!-- Seller Stats -->
      <div class="col-md-3">
        <div class="card text-dark bg-white mb-3">
          <div class="card-header">Total Sales</div>
          <div class="card-body">
            <h5 class="card-title">${{ seller_stats.total_sales }}</h5>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card text-dark bg-white mb-3">
          <div class="card-header">Total Orders</div>
          <div class="card-body">
            <h5 class="card-title">{{ seller_stats.total_orders }}</h5>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card text-dark bg-white mb-3">
          <div class="card-header">Average Rating</div>
          <div class="card-body">
            <h5 class="card-title">
              <div class="star-rating">
                {% for i in range(1, 6) %}
                  {% if seller_stats.average_rating >= i %}
                  <i class="fa fa-star filled"></i>
                  {% elif seller_stats.average_rating > i - 1 %}
                  <i
                    class="fa fa-star filled fractional"
                    style="--fraction-width: {{ (seller_stats.average_rating - (i - 1)) * 100 }}%;"
                  ></i>
                  {% else %}
                  <i class="fa fa-star empty"></i>
                  {% endif %}
                {% endfor %}
              </div>
            </h5>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card text-dark bg-white mb-3">
          <div class="card-header">Products Listed</div>
          <div class="card-body">
            <h5 class="card-title">{{ seller_stats.products_listed }}</h5>
          </div>
        </div>
      </div>
    {% endif %}
    </div>

  <div class="button-group" style="margin-top: 30px">
    <a
      href="/view_inventory"
      class="btn btn-primary btn-lg"
      style="width: 200px; padding: 25px"
    >
      <i class="fa fa-box"></i> View Inventory
    </a>
    <button
      type="button"
      class="btn btn-primary btn-lg"
      style="width: 200px; padding: 25px"
      data-toggle="modal"
      data-target="#addItemModal"
    >
      <i class="fa fa-plus"></i> Create new listing
    </button>
    <a
      href="/view_orders"
      class="btn btn-primary btn-lg"
      style="width: 200px; padding: 25px"
    >
      <i class="fa fa-shopping-cart"></i> View Orders
    </a>
  </div>
</div>

<script>
  // JavaScript for Handling Modals
  document.getElementById("createNewProductBtn").addEventListener("click", () => {
    document.getElementById("newProductForm").classList.remove("d-none");
    document.getElementById("existingProductForm").classList.add("d-none");
  });

  document.getElementById("selectExistingProductBtn").addEventListener("click", () => {
    document.getElementById("existingProductForm").classList.remove("d-none");
    document.getElementById("newProductForm").classList.add("d-none");
  });

  document
    .getElementById("newProductForm")
    .addEventListener("submit", async function (event) {
      event.preventDefault();
      const formData = new FormData(event.target);
      const data = Object.fromEntries(formData.entries());
      try {
        const response = await fetch("/products", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(data),
        });
        if (response.ok) {
          alert("New product created successfully!");
          $("#addItemModal").modal("hide");
        } else {
          const result = await response.json();
          alert(result.error || "Failed to create product.");
        }
      } catch (error) {
        console.error("Error:", error);
        alert("An unexpected error occurred.");
      }
    });

  document
    .getElementById("searchProductBtn")
    .addEventListener("click", async function () {
      const searchQuery = document
        .getElementById("search_existing")
        .value.trim(); // Get the user input
      const resultsContainer = document.getElementById("productResults");
      resultsContainer.innerHTML = ""; // Clear previous results

      if (!searchQuery) {
        resultsContainer.innerHTML = "<p>Please enter a search term.</p>";
        return;
      }

      try {
        // Fetch existing products from the new endpoint
        const response = await fetch(`/products/search_existing?q=${encodeURIComponent(searchQuery)}`);
        const data = await response.json();

        if (data.products.length === 0) {
          resultsContainer.innerHTML = "<p>No matching products found.</p>";
          return;
        }

        // Display matching products
        data.products.forEach((product) => {
          const productDiv = document.createElement("div");
          productDiv.className = "product-item";
          productDiv.innerHTML = `
            <div class="card mb-3">
              <div class="card-body">
                <h5>${product.name}</h5>
                <p>${product.description}</p>
                <p><strong>Category:</strong> ${product.category_name}</p>
                <p><strong>Price:</strong> $${product.price.toFixed(2)}</p>
                <button 
                  class="btn btn-success" 
                  onclick="createListingForProduct(${product.product_id}, '${product.name}')"
                >
                  Create Listing for This Product
                </button>
              </div>
            </div>
          `;
          resultsContainer.appendChild(productDiv);
        });
      } catch (error) {
        console.error("Error fetching products:", error);
        resultsContainer.innerHTML = "<p>Failed to fetch products. Try again later.</p>";
      }
    });

  async function createListingForProduct(productId, productName) {
    const quantity = prompt(`Enter the quantity for ${productName}:`);

    if (!quantity || isNaN(quantity)) {
      alert("Valid quantity is required.");
      return;
    }

    try {
      // Make the POST request to create the listing
      const response = await fetch("/products/create_listing", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          product_id: productId,
          quantity: parseInt(quantity, 10), // Pass only product_id and quantity
        }),
      });

      if (response.ok) {
        alert("Listing created successfully!");
      } else {
        const result = await response.json();
        alert(result.error || "Failed to create listing.");
      }
    } catch (error) {
      console.error("Error creating listing:", error);
      alert("An unexpected error occurred.");
    }
  }
</script>

<style>
  .star-rating {
    justify-content: center;
    align-items: center;
  }
  .d-none {
    display: none;
  }
</style>

{% endblock %}
