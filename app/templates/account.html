{% extends "base.html" %} {% block content %}

<br />
<br />
<h2 style="padding-left: 3vw">My Account:</h2>
<hr />
<div class="container-account">
  <div class="info">
    <h3>Personal Information</h3>
    <form action="/account" method="POST" class="form">
      <input type="hidden" name="form_id" value="full_name" />
      <h4 class="label">Full Name:</h4>
      <div class="field input-group">
        <input
          id="full_name"
          name="full_name"
          type="text"
          class="form-control"
          value="{{full_name}}"
          required
        />
      </div>
      <button type="submit" class="submit">
        <a class="btn btn-secondary"><i class="fa fa-edit"></i></a>
      </button>
    </form>
    <form action="/account" method="POST" class="form">
      <input type="hidden" name="form_id" value="email" />
      <h4 class="label">Email:</h4>
      <div class="field input-group">
        <input
          id="email"
          name="email"
          type="text"
          class="form-control"
          value="{{email}}"
          disabled
        />
      </div>
      <button type="submit" class="submit disabled" disabled>
        <a class="btn btn-secondary"><i class="fa fa-edit"></i></a>
      </button>
    </form>
    <form action="/account" method="POST" class="form">
      <input type="hidden" name="form_id" value="address" />
      <h4 class="label">Address:</h4>
      <div class="field input-group">
        <input
          id="address"
          name="address"
          type="text"
          class="form-control"
          value="{{address}}"
          required
        />
      </div>
      <button type="submit" class="submit">
        <a class="btn btn-secondary"><i class="fa fa-edit"></i></a>
      </button>
    </form>
    <form action="/account" method="POST" class="form">
      <input type="hidden" name="form_id" value="balance" />
      <h4 class="label">Balance:</h4>
      <div class="field input-group">
        <input
          id="balance"
          name="balance"
          type="number"
          step="0.01"
          class="form-control"
          value="{{balance}}"
          required
        />
      </div>
      <button type="submit" class="submit">
        <a class="btn btn-secondary"><i class="fa fa-edit"></i></a>
      </button>
    </form>
  </div>

  <!-- Purchase History and Pagination -->
  <div class="history" style="height: 5vh;">
    <h1>Purchase History</h1>
    <table class="table table-hover table-bordered container">
      <thead class="thead-dark">
        <tr>
          <th scope="col">Product Name</th>
          <th scope="col">Description</th>
          <th scope="col">Category</th>
          <th scope="col">Quantity</th>
          <th scope="col">Price</th>
          <th scope="col">Date Ordered</th>
          <th scope="col">Submit Review</th>
          <th scope="col">Seller</th>
        </tr>
      </thead>
      <tbody id="orderHistoryTableBody">
        {% for purchase in order_history %}
        <tr>
          <td>{{ purchase['name'] }}</td>
          <td>{{ purchase['description'] }}</td>
          <td>{{ purchase['category_name'] }}</td>
          <td>{{ purchase['quantity'] }}</td>
          <td>{{ purchase['price'] }}</td>
          <td>{{ purchase['ordered_time'] }}</td>
          <td>
            <form id="reviewForm-{{ purchase['product_id'] }}" class="review-form">
              <input type="hidden" name="product_id" value="{{ purchase['product_id'] }}">
              <input type="hidden" name="seller_id" value="{{ purchase['seller_id'] }}">
              <input type="number" name="rating" min="1" max="5" required placeholder="Rating (1-5)">
              <textarea name="comment" placeholder="Your review" required></textarea>
              <button type="button" class="btn btn-primary" onclick="submitReview(event, purchase['product_id'])">Submit Review</button>
            </form>
          </td>
          <td>
            <button class="btn btn-link" onclick="redirectToSellerPage('{{ purchase.seller_id }}')">
              View Seller
            </button>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    <div id="pagination-controls" class="container my-4">
      <button id="prev-page" class="btn btn-secondary" onclick="cP(-1)" {% if page <= 1 %}disabled{% endif %}>Previous</button>
      <span>Page {{ page }} of {{ total_pages }}</span>
      <button id="next-page" class="btn btn-secondary" onclick="cP(1)" {% if page >= total_pages %}disabled{% endif %}>Next</button>
    </div>
  </div>

  <script>
    function cP(offset) {
      const currentPage = parseInt("{{ page }}", 10);
      const totalPages = parseInt("{{ total_pages }}", 10);
      const newPage = currentPage + offset;
  
      if (newPage < 1 || newPage > totalPages) return;
  
      const url = new URL(window.location.href);
      url.searchParams.set("page", newPage);
      window.location.href = url.toString();
    }

    async function submitReview(event, productId) {
      event.preventDefault();
      const form = document.getElementById(`reviewForm-${productId}`);
      const formData = new FormData(form);
      const data = Object.fromEntries(formData.entries());

      try {
        const response = await fetch('/api/reviews/submit', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(data),
        });

        const result = await response.json();
        
        if (response.ok) {
          alert('Review submitted successfully!'); // Notify success
          fetchRecentReviews(); // Refresh the recent reviews section
        } else {
          alert(result.error || 'An error occurred while submitting the review.'); // Notify error
        }
      } catch (error) {
        console.error('Error:', error);
        alert('An unexpected error occurred.');
      }
    }
  </script>

  <!-- Button to redirect to Most Recent Reviews -->
  <div class="recent-reviews">
    <h1>Most Recent Reviews</h1>
    <button class="btn btn-primary" onclick="redirectToRecentReviews()">
      View Recent Reviews
    </button>
  </div>
</div>
<!-- Inventory Listing -->
<h2 style="margin-left: 5%">Selling Inventory</h2>
<table id="inventoryTable" border="1" style="width: 90%; margin-left: 5%; margin-top: 20px;">
  <thead>
    <tr>
      <th>Inventory ID</th>
      <th>Seller ID</th>
      <th>Product ID</thth>
      <th>Quantity</th>
      <th>Product Name</th>
      <th>Description</th>
      <th>Image</th>
      <th>Price</th>
      <th>Actions</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<script>
  let currentPage = 1;
  const perPage = 10;

  function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`); 
    if (parts.length === 2) return parts.pop().split(";").shift();
  }

  async function fetchInventory(page) {
    const userId = getCookie("id");
    if (!userId) {
      console.error("User ID cookie not found");
      return;
    }

    try {
      const response = await fetch(`/api/inventory?user_id=${userId}&page=${page}&limit=${perPage}`);
      const data = await response.json();

      if (data.error) {
        console.error(data.error);
        return;
      }

      const inventory = data.inventory;
      const tableBody = document.getElementById("inventoryTable").querySelector("tbody");
      tableBody.innerHTML = ""; 

      inventory.forEach(item => {
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${item.inventory_id}</td>
          <td>${item.seller_id}</td>
          <td>${item.product_id}</td>
          <td>
            <input 
              type="number" 
              id="quantity-${item.inventory_id}" 
              value="${item.quantity}" 
              class="form-control" 
              style="width: 80px; display: inline;" />
          </td>
          <td>${item.product_name}</td>
          <td>${item.description}</td>
          <td><img src="${item.image_url}" alt="Product Image" width="50"></td>
          <td>${item.price}</td>
          <td>
            <button class="btn btn-primary btn-sm" onclick="updateQuantity(${item.inventory_id})">Update</button>
            <button class="btn btn-danger btn-sm" onclick="deleteProduct(${item.inventory_id})">Delete</button>
          </td>
        `;
        tableBody.appendChild(row);
      });
    } catch (error) {
      console.error("Error loading inventory:", error);
    }
  }

  async function updateQuantity(inventoryId) {
    const quantityInput = document.getElementById(`quantity-${inventoryId}`);
    const newQuantity = parseInt(quantityInput.value, 10);

    if (isNaN(newQuantity) || newQuantity < 0) {
      alert("Please enter a valid quantity.");
      return;
    }

    try {
      const response = await fetch(`/api/update_quantity`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ inventory_id: inventoryId, quantity: newQuantity }),
      });

      const result = await response.json();

      if (response.ok) {
        alert("Quantity updated successfully!");
        fetchInventory(currentPage);
      } else {
        alert(result.error || "Failed to update quantity.");
      }
    } catch (error) {
      console.error("Error updating quantity:", error);
      alert("An unexpected error occurred.");
    }
  }

  async function deleteProduct(inventoryId) {
    if (!confirm("Are you sure you want to delete this product?")) {
      return;
    }

    try {
      const response = await fetch(`/api/delete_product`, {
        method: 'DELETE',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ inventory_id: inventoryId }),
      });

      const result = await response.json();

      if (response.ok) {
        alert("Product deleted successfully!");
        fetchInventory(currentPage); 
      } else {
        alert(result.error || "Failed to delete product.");
      }
    } catch (error) {
      console.error("Error deleting product:", error);
      alert("An unexpected error occurred.");
    }
  }

  fetchInventory(currentPage);

  function redirectToRecentReviews() {
    window.location.href = "/reviewsrecent";
  }
</script>

<!--Add to Inventory Form-->
<!-- Add Inventory Form -->
<form id="addInventoryForm" style="width: 90%; margin-left: 5%; margin-top: 20px;">
  <div class="form-group">
    <label for="category_name">Category Name:</label>
    <input type="text" id="category_name" name="category_name" class="form-control" required>
  </div>
  <div class="form-group">
    <label for="name">Product Name:</label>
    <input type="text" id="name" name="name" class="form-control" required>
  </div>
  <div class="form-group">
    <label for="description">Description:</label>
    <textarea id="description" name="description" class="form-control" rows="3" required></textarea>
  </div>
  <div class="form-group">
    <label for="image_url">Image URL:</label>
    <input type="url" id="image_url" name="image_url" class="form-control" required>
  </div>
  <div class="form-group">
    <label for="price">Price:</label>
    <input type="number" id="price" name="price" class="form-control" step="0.01" required>
  </div>
  <div class="form-group">
    <label for="quantity">Quantity:</label>
    <input type="number" id="quantity" name="quantity" class="form-control" required>
  </div>
  <button type="submit" class="btn btn-primary">Add to Inventory</button>
</form>

<script>
function loadInventory() {
    window.location.reload(); // Reload the entire page
}
document.getElementById('addInventoryForm').addEventListener('submit', async function (event) {
    event.preventDefault(); // Prevent default form submission

    const formData = new FormData(event.target);
    const data = Object.fromEntries(formData.entries()); // Convert FormData to JSON

    try {
        const response = await fetch('/add_inventory', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data),
        });

        const result = await response.json();

        if (response.ok) {
            alert('Item added successfully!');
            loadInventory(); // Refresh inventory table
        } else {
            alert(result.error || 'An error occurred while adding the item.');
        }
    } catch (error) {
        console.error('Error:', error);
        alert('An unexpected error occurred.');
    }
});
</script>

<br>
<br>

<h2>Seller Orders</h2>
<div style="margin: 20px;">
  <input 
      type="text" 
      id="searchInput" 
      placeholder="Search orders by buyer name, order ID, or address" 
      style="width: 300px; padding: 5px;"
  />
  <button onclick="loadOrders()" style="padding: 5px;">Search</button>
</div>

<table id="ordersTable" border="1" style="width: 90%; margin: 20px;">
  <thead>
    <tr>
      <th>Order ID</th>
      <th>Buyer Name</th>
      <th>Buyer Address</th>
      <th>Date Ordered</th>
      <th>Quantity</th>
      <th>Total Amount</th>
      <th>Order Status</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>


<script>
async function loadOrders() {
    try {
        const searchQuery = document.getElementById('searchInput').value.trim();
        const response = await fetch(`/orders/api/seller_orders?search=${encodeURIComponent(searchQuery)}`);
        const data = await response.json();

        if (data.error) {
            console.error(data.error);
            return;
        }

        const ordersTable = document.getElementById("ordersTable").querySelector("tbody");
        ordersTable.innerHTML = ""; // Clear existing rows

        data.orders.forEach(order => {
            const totalAmount = (order.quantity * order.unit_price).toFixed(2);

            const row = document.createElement("tr");
            row.innerHTML = `
                <td>${order.order_id}</td>
                <td>${order.buyer_name}</td>
                <td>${order.buyer_address}</td>
                <td>${new Date(order.ordered_time).toLocaleDateString()}</td>
                <td>${order.quantity}</td>
                <td>${totalAmount}</td>
                <td>${order.order_status}</td>
            `;
            ordersTable.appendChild(row);
        });
    } catch (error) {
        console.error("Error loading orders:", error);
    }
}

// Load orders when page loads
loadOrders();
  function redirectToRecentReviews() {
    window.location.href = '/reviewsrecent';
  }
</script>





{% endblock %}
