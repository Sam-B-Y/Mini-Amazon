{% extends "base.html" %} {% block content %}
<div class="product-detail-container">
  <div class="product-main">
    <img
      src="{{ product.image_url }}"
      alt="{{ product.name }}"
      class="product-image"
    />
    <div class="product-info">
      <h1>{{ product.name }}</h1>
      <p class="price">${{ "%.2f"|format(product.price) }}</p>
      <p class="category">
        Category:
        <a href="/category/{{product.category_name}}"
          >{{ product.category_name }}</a
        >
      </p>
      <p class="rating">
        <div class="star-rating">
          {% set average_rating = reviews | map(attribute='rating') | sum / reviews | length if reviews else 0 %}
          {% for i in range(1, 6) %} {% if average_rating >= i %}
          <i class="fa fa-star filled"></i>
          {% elif average_rating > i - 1 %}
          <i
            class="fa fa-star filled fractional"
            style="--fraction-width: {{ (average_rating - (i - 1)) * 100 }}%;"
          ></i>
          {% else %}
          <i class="fa fa-star empty"></i>
          {% endif %} {% endfor %}
        <span style="font-size: medium;">({{ reviews|length if reviews else 0 }} ratings)</span>
        </div>
      </p>
    </div>
  </div>

  <p class="description">{{ product.description }}</p>

  <!-- Sellers Section -->
  <div class="sellers-section">
    <h3>Available from Sellers</h3>
    {% if sellers %}
    <div class="sellers-list">
      {% for seller in sellers %}
      <div class="seller-card">
        <div class="seller-info">
          <h4><a href="/user/{{ seller.seller_id }}">{{ seller.seller_name }}</a></h4>
          <div class="star-rating">
            {% for i in range(1, 6) %}
              {% if seller.avg_rating >= i %}
                <i class="fa fa-star filled"></i>
              {% else %}
                <i class="fa fa-star empty"></i>
              {% endif %}
            {% endfor %}
            <span>({{ seller.review_count }} reviews)</span>
          </div>
          <p class="price">${{ "%.2f"|format(seller.unit_price) }}</p>
          <p>Available: {{ seller.quantity }}</p>
          <form class="add-to-cart-form" data-seller-id="{{ seller.seller_id }}">
            <input type="number" name="quantity" min="1" max="{{ seller.quantity }}" value="1" />
            <button type="submit" class="add-to-cart-btn">
              <i class="fa fa-shopping-basket"></i> Add to Cart
            </button>
          </form>
        </div>
      </div>
      {% endfor %}
    </div>
    {% else %}
    <p class="text-muted">No sellers currently have this item in stock.</p>
    {% endif %}
  </div>

  <!-- Reviews Section -->
  <div class="reviews-section">
    <h2>Product Reviews</h2>
    <div class="center-review">
      {% if reviews %}
        {% for review in reviews %}
        <div class="card mb-3">
          <div class="card-body">
            <div class="d-flex align-items-center mb-2">
              <div class="star-rating centered-stars">
                {% for i in range(1, 6) %}
                  {% if review.rating >= i %}
                    <i class="fa fa-star filled"></i>
                  {% else %}
                    <i class="fa fa-star empty"></i>
                  {% endif %}
                {% endfor %}
              </div>
              <span class="ms-2">{{ review.reviewer_name }}</span>
            </div>
            <p class="mb-1">{{ review.comment }}</p>
            <small class="text-muted">Added at: {{ review.added_at }}</small>
          </div>
        </div>
        {% endfor %}
      {% else %}
        <p class="text-muted">No reviews yet.</p>
      {% endif %}
    </div>
  </div>
</div>

<script>
  document.querySelectorAll(".add-to-cart-form").forEach((form) => {
    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      const sellerId = form.dataset.sellerId;
      const quantity = form.querySelector('input[name="quantity"]').value;

      try {
        const formData = new FormData();
        formData.append("product_id", "{{ product.product_id }}");
        formData.append("seller_id", sellerId);
        formData.append("quantity", parseInt(quantity));

        const response = await fetch("/cart/add", {
          method: "POST",
          body: formData,
        });

        if (response.ok) {
          alert("Added to cart successfully!");
        } else {
          alert("Failed to add to cart. Please try again.");
        }
      } catch (error) {
        console.error("Error:", error);
        alert("An error occurred. Please try again.");
      }
    });
  });
</script>

<style>
  .product-detail-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
  }

  .product-main {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
    margin-bottom: 40px;
  }

  .product-image {
    width: 80%;
    max-height: 500px;
    object-fit: cover;
    border-radius: 8px;
  }

  .product-info {
    padding: 20px;
  }

  .price {
    font-size: 24px;
    font-weight: bold;
    color: #ad5d5d;
  }

  .sellers-section {
    margin-top: 20px;
    padding: 20px;
    background: #1c1c1e;
    border-radius: 8px;
  }

  .sellers-list {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 20px;
  }

  .seller-card {
    background: #2c2c2e;
    padding: 15px;
    border-radius: 8px;
    transition: transform 0.2s;
  }

  .seller-card:hover {
    transform: translateY(-2px);
  }

  .seller-info h4 {
    margin-bottom: 10px;
  }

  .seller-info h4 a {
    color: #fff;
    text-decoration: none;
  }

  .seller-info h4 a:hover {
    color: #3498db;
  }

  .add-to-cart-form {
    display: flex;
    gap: 10px;
    margin-top: 10px;
  }

  .add-to-cart-btn {
    background-color: #3498db;
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 4px;
    cursor: pointer;
  }

  .add-to-cart-btn:hover {
    background-color: #2980b9;
  }

  .star-rating {
    display: flex;
    color: #f1c40f;
  }

  .card {
    border: none;
    background: #1c1c1e;
    color: #fff;
    width: 80%;
    text-align: center;
  }

  .card .card-body {
    padding: 1rem;
  }

  .center-review {
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
  }

  .reviews-section {
    margin-top: 40px;
  }

  .star-rating .filled {
    color: #f1c40f;
  }

  .star-rating .empty {
    color: #666;
  }

  .star-rating span {
    margin-left: 8px;
    color: #666;
  }
</style>
{% endblock %}
